-- [[ ABBAS GITHUB GLOBAL CHAT V10 ]] --
local HttpService = game:GetService("HttpService")
local Player = game.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- 1. [بياناتك الخاصة - عبّيها هنا]
local GITHUB_TOKEN = "Bearer " .. "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" 
local REPO_OWNER = "abasameerz15-tech"
local REPO_NAME = "ChatData" -- اسم المستودع اللي سويته
local FILE_PATH = "messages.json" -- اسم الملف اللي داخل المستودع

-- رابط البروكسي (عشان نتخطى حظر روبلوكس لـ جيثب)
local URL = string.format("https://api.github.com/repos/%s/%s/contents/%s", REPO_OWNER, REPO_NAME, FILE_PATH)

-- 2. واجهة المستخدم (تصميم MOON الأسود)
local sg = Instance.new("ScreenGui", PlayerGui)
sg.Name = "AbbasGlobalV10"
sg.ResetOnSpawn = false

local btn = Instance.new("TextButton", sg)
btn.Size = UDim2.new(0, 60, 0, 40)
btn.Position = UDim2.new(0, 15, 0.5, 0)
btn.Text = "MOON"
btn.BackgroundColor3 = Color3.new(0,0,0)
btn.TextColor3 = Color3.new(1,1,1)
btn.Draggable = true
Instance.new("UICorner", btn)

local frame = Instance.new("Frame", sg)
frame.Size = UDim2.new(0, 280, 0, 320)
frame.Position = UDim2.new(0.5, -140, 0.5, -160)
frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
frame.Visible = false
frame.Draggable = true
Instance.new("UICorner", frame)
Instance.new("UIStroke", frame).Color = Color3.fromRGB(255, 0, 85)

local log = Instance.new("ScrollingFrame", frame)
log.Size = UDim2.new(1, -20, 1, -100)
log.Position = UDim2.new(0, 10, 0, 10)
log.BackgroundTransparency = 1
log.AutomaticCanvasSize = Enum.AutomaticSize.Y
local layout = Instance.new("UIListLayout", log)

local input = Instance.new("TextBox", frame)
input.Size = UDim2.new(1, -20, 0, 40)
input.Position = UDim2.new(0, 10, 1, -50)
input.PlaceholderText = "رسالة عالمية عبر جيثب..."
input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
input.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", input)

-- 3. وظيفة إحضار الرسالة وعرضها
function AddMsg(senderName, txt)
    local t = Instance.new("TextLabel", log)
    t.Size = UDim2.new(1, 0, 0, 30)
    t.BackgroundTransparency = 1
    t.Text = "<b>" .. senderName .. "</b>: " .. txt
    t.RichText = true
    t.TextColor3 = Color3.new(1,1,1)
    t.TextXAlignment = Enum.TextXAlignment.Left
    log.CanvasPosition = Vector2.new(0, 9999)
end

-- 4. [السر] إرسال الرسالة لجيثب وتحديث الملف
local function SendToGithub(txt)
    task.spawn(function()
        pcall(function()
            -- إحضار الملف الحالي للحصول على الـ SHA
            local res = HttpService:RequestAsync({
                Url = URL,
                Method = "GET",
                Headers = {["Authorization"] = GITHUB_TOKEN}
            })
            local fileData = HttpService:JSONDecode(res.Body)
            
            -- تجهيز البيانات الجديدة (تحويل النص لـ Base64 لأن جيثب يطلبه)
            local newData = HttpService:JSONEncode({sender = Player.Name, msg = txt, time = os.time()})
            local encodedContent = game:GetService("Base64Service"):Encode(newData) -- ملاحظة: بعض المحركات تحتاج مكتبة Base64 خارجية
            
            -- تحديث الملف في جيثب
            HttpService:RequestAsync({
                Url = URL,
                Method = "PUT",
                Headers = {
                    ["Authorization"] = GITHUB_TOKEN,
                    ["Content-Type"] = "application/json"
                },
                Body = HttpService:JSONEncode({
                    message = "Update Chat",
                    content = encodedContent,
                    sha = fileData.sha
                })
            })
        end)
    end)
end

-- 5. مراقبة التحديثات (تراقب جيثب كل 5 ثواني)
task.spawn(function()
    local lastTime = 0
    while task.wait(5) do
        pcall(function()
            local res = HttpService:GetAsync(URL .. "?nocache=" .. os.time())
            local data = HttpService:JSONDecode(res.Body)
            -- فك تشفير المحتوى من جيثب
            local contentRaw = game:GetService("Base64Service"):Decode(data.content)
            local finalData = HttpService:JSONDecode(contentRaw)
            
            if finalData.time > lastTime then
                lastTime = finalData.time
                AddMsg(finalData.sender, finalData.msg)
            end
        end)
    end
end)

input.FocusLost:Connect(function(e)
    if e and input.Text ~= "" then
        SendToGithub(input.Text)
        input.Text = ""
    end
end)

btn.MouseButton1Click:Connect(function() frame.Visible = not frame.Visible end)
