local Player = game.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local UIS = game:GetService("UserInputService")
local TextChatService = game:GetService("TextChatService")

-- إنشاء الواجهة
local sg = Instance.new("ScreenGui", PlayerGui)
sg.Name = "AbbasUltraV4"
sg.ResetOnSpawn = false

-- [1] زر الفتح (CHAT) - قابل للتحريك
local btn = Instance.new("TextButton", sg)
btn.Size = UDim2.new(0, 60, 0, 60)
btn.Position = UDim2.new(0, 20, 0.5, 0)
btn.Text = "CHAT"
btn.BackgroundColor3 = Color3.fromRGB(255, 0, 85)
btn.TextColor3 = Color3.new(1,1,1)
btn.Font = Enum.Font.GothamBold
btn.Draggable = true -- تفعيل التحريك البسيط
Instance.new("UICorner", btn).CornerRadius = UDim.new(1,0)

-- [2] قائمة المحادثة
local frame = Instance.new("Frame", sg)
frame.Size = UDim2.new(0, 300, 0, 320)
frame.Position = UDim2.new(0.5, -150, 0.5, -160)
frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
frame.Visible = false -- تبدأ مخفية
frame.Active = true
frame.Draggable = true -- القائمة أيضاً قابلة للتحريك
Instance.new("UICorner", frame)
local stroke = Instance.new("UIStroke", frame)
stroke.Color = Color3.fromRGB(255, 0, 85)
stroke.Thickness = 2

-- منطقة الرسائل
local log = Instance.new("ScrollingFrame", frame)
log.Size = UDim2.new(1, -20, 1, -100)
log.Position = UDim2.new(0, 10, 0, 10)
log.BackgroundTransparency = 1
log.CanvasSize = UDim2.new(0,0,0,0)
log.AutomaticCanvasSize = Enum.AutomaticSize.Y
local layout = Instance.new("UIListLayout", log)
layout.Padding = UDim.new(0, 5)

-- مكان الكتابة
local input = Instance.new("TextBox", frame)
input.Size = UDim2.new(1, -20, 0, 45)
input.Position = UDim2.new(0, 10, 1, -55)
input.PlaceholderText = "اكتب هنا وارسل..."
input.Text = ""
input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
input.TextColor3 = Color3.new(1,1,1)
input.Font = Enum.Font.SourceSans
input.TextSize = 18
Instance.new("UICorner", input)

-- [3] وظيفة إضافة الرسالة مع سكن اللاعب
function AddMsg(sender, txt)
    if not sender then return end
    local mFrame = Instance.new("Frame", log)
    mFrame.Size = UDim2.new(1, 0, 0, 35)
    mFrame.BackgroundTransparency = 1
    
    local img = Instance.new("ImageLabel", mFrame)
    img.Size = UDim2.new(0, 30, 0, 30)
    img.Image = game.Players:GetUserThumbnailAsync(sender.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size48x48)
    Instance.new("UICorner", img).CornerRadius = UDim.new(1,0)
    
    local t = Instance.new("TextLabel", mFrame)
    t.Size = UDim2.new(1, -40, 1, 0)
    t.Position = UDim2.new(0, 40, 0, 0)
    t.BackgroundTransparency = 1
    t.Text = "<b>" .. sender.Name .. "</b>: " .. txt
    t.RichText = true
    t.TextColor3 = Color3.new(1,1,1)
    t.TextXAlignment = Enum.TextXAlignment.Left
    t.TextWrapped = true

    log.CanvasPosition = Vector2.new(0, 99999)
end

-- [4] نظام فتح وإغلاق القائمة (تصحيح)
btn.MouseButton1Click:Connect(function()
    frame.Visible = not frame.Visible
    print("Chat Toggle: " .. tostring(frame.Visible)) -- للتأكد في الكونسول
end)

-- [5] نظام الإرسال (متوافق مع النظام الجديد والقديم)
input.FocusLost:Connect(function(enter)
    if enter and input.Text ~= "" then
        local msg = input.Text
        -- محاولة الإرسال عبر النظام الجديد
        local chatChannel = TextChatService:FindFirstChild("TextChannels") and TextChatService.TextChannels:FindFirstChild("RBXGeneral")
        if chatChannel then
            chatChannel:SendAsync(msg)
        else
            -- محاولة الإرسال عبر النظام القديم
            local event = game.ReplicatedStorage:FindFirstChild("SayMessageRequest", true)
            if event then
                event:FireServer(msg, "All")
            end
        end
        input.Text = ""
    end
end)

-- [6] استقبال الرسائل (النظام الجديد)
if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
    TextChatService.OnIncomingMessage = function(message)
        if message.TextSource then
            local sender = game.Players:GetPlayerByUserId(message.TextSource.UserId)
            if sender then AddMsg(sender, message.Text) end
        end
    end
else
    -- استقبال الرسائل (النظام القديم)
    local chatEvents = game.ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
    if chatEvents then
        chatEvents:WaitForChild("OnMessageDoneFiltering").OnClientEvent:Connect(function(data)
            local sender = game.Players:FindFirstChild(data.FromSpeaker)
            if sender then AddMsg(sender, data.Message) end
        end)
    end
end
