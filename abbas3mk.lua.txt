local Player = game.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local UIS = game:GetService("UserInputService")

-- إنشاء الواجهة
local sg = Instance.new("ScreenGui", PlayerGui)
sg.Name = "AbbasUltraChat"
sg.ResetOnSpawn = false

-- الزر العائم
local btn = Instance.new("TextButton", sg)
btn.Size = UDim2.new(0, 50, 0, 50)
btn.Position = UDim2.new(0, 20, 0.5, 0)
btn.Text = "CHAT"
btn.BackgroundColor3 = Color3.fromRGB(255, 0, 85)
btn.TextColor3 = Color3.new(1,1,1)
btn.Draggable = true
Instance.new("UICorner", btn).CornerRadius = UDim.new(1,0)

-- القائمة
local frame = Instance.new("Frame", sg)
frame.Size = UDim2.new(0, 280, 0, 300)
frame.Position = UDim2.new(0.5, -140, 0.5, -150)
frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
frame.Visible = false
frame.Active = true
frame.Draggable = true
Instance.new("UICorner", frame)
Instance.new("UIStroke", frame).Color = Color3.fromRGB(255, 0, 85)

-- الشات
local log = Instance.new("ScrollingFrame", frame)
log.Size = UDim2.new(1, -20, 1, -80)
log.Position = UDim2.new(0, 10, 0, 10)
log.BackgroundTransparency = 1
log.CanvasSize = UDim2.new(0,0,0,0)
log.AutomaticCanvasSize = Enum.AutomaticSize.Y
local layout = Instance.new("UIListLayout", log)
layout.Padding = UDim.new(0, 5)

-- مكان الكتابة
local input = Instance.new("TextBox", frame)
input.Size = UDim2.new(1, -20, 0, 40)
input.Position = UDim2.new(0, 10, 1, -50)
input.PlaceholderText = "اكتب رسالة للجميع..."
input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
input.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", input)

-- وظيفة إضافة الرسالة مع الصورة
function AddMsg(sender, txt)
    local mFrame = Instance.new("Frame", log)
    mFrame.Size = UDim2.new(1, 0, 0, 35)
    mFrame.BackgroundTransparency = 1
    
    local img = Instance.new("ImageLabel", mFrame)
    img.Size = UDim2.new(0, 30, 0, 30)
    img.Image = game.Players:GetUserThumbnailAsync(sender.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size48x48)
    Instance.new("UICorner", img).CornerRadius = UDim.new(1,0)
    
    local t = Instance.new("TextLabel", mFrame)
    t.Size = UDim2.new(1, -40, 1, 0)
    t.Position = UDim2.new(0, 40, 0, 0)
    t.BackgroundTransparency = 1
    t.Text = "<b>" .. sender.Name .. "</b>: " .. txt
    t.RichText = true
    t.TextColor3 = Color3.new(1,1,1)
    t.TextXAlignment = Enum.TextXAlignment.Left
    t.TextWrapped = true

    log.CanvasPosition = Vector2.new(0, 99999)
end

-- [ السر هنا ] مراقبة شات السيرفر الرسمي وعرضه في قائمتك
game.ReplicatedStorage:WaitForChild("DefaultChatSystemChatEvents", 10).OnMessageDoneFiltering.OnClientEvent:Connect(function(data)
    local sender = game.Players:FindFirstChild(data.FromSpeaker)
    local message = data.Message
    if sender then
        AddMsg(sender, message)
    end
end)

-- الإرسال عبر الشات الرسمي (عشان الكل يشوفه)
input.FocusLost:Connect(function(enter)
    if enter and input.Text ~= "" then
        game.ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(input.Text, "All")
        input.Text = ""
    end
end)

btn.MouseButton1Click:Connect(function() frame.Visible = not frame.Visible end)
