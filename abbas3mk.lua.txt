--[[ ABBAS ELITE V5 - THE FINAL HOPE ]]--
local Player = game.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local UIS = game:GetService("UserInputService")

-- 1. إنشاء الواجهة
local sg = Instance.new("ScreenGui", PlayerGui)
sg.Name = "AbbasV5"
sg.ResetOnSpawn = false

-- زر CHAT (قابل للتحريك)
local btn = Instance.new("TextButton", sg)
btn.Size = UDim2.new(0, 50, 0, 50)
btn.Position = UDim2.new(0, 15, 0.5, 0)
btn.Text = "CHAT"
btn.BackgroundColor3 = Color3.fromRGB(255, 0, 85)
btn.TextColor3 = Color3.new(1,1,1)
btn.Draggable = true
Instance.new("UICorner", btn).CornerRadius = UDim.new(1,0)

-- القائمة
local frame = Instance.new("Frame", sg)
frame.Size = UDim2.new(0, 260, 0, 280)
frame.Position = UDim2.new(0.5, -130, 0.5, -140)
frame.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
frame.Visible = false
frame.Active = true
frame.Draggable = true
Instance.new("UICorner", frame)
Instance.new("UIStroke", frame).Color = Color3.fromRGB(255, 0, 85)

-- الشات
local log = Instance.new("ScrollingFrame", frame)
log.Size = UDim2.new(1, -20, 1, -90)
log.Position = UDim2.new(0, 10, 0, 10)
log.BackgroundTransparency = 1
log.CanvasSize = UDim2.new(0,0,0,0)
log.AutomaticCanvasSize = Enum.AutomaticSize.Y
local layout = Instance.new("UIListLayout", log)
layout.Padding = UDim.new(0, 5)

-- مكان الكتابة
local input = Instance.new("TextBox", frame)
input.Size = UDim2.new(1, -20, 0, 40)
input.Position = UDim2.new(0, 10, 1, -50)
input.PlaceholderText = "اكتب هنا..."
input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
input.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", input)

-- [ السر الحقيقي ] نظام نقل الرسائل عبر القيم المخفية
local function GetSignal(p)
    local folder = p:FindFirstChild("Backpack") -- الحقيبة دايم موجودة والكل يشوفها
    if folder then
        local sig = folder:FindFirstChild("AbbasMsg")
        if not sig then
            sig = Instance.new("StringValue")
            sig.Name = "AbbasMsg"
            sig.Parent = folder
        end
        return sig
    end
end

local MySignal = GetSignal(Player)

function AddMsg(senderName, txt, senderUserId)
    -- منع التكرار (نتأكد إن الرسالة ما انضافت قبل ثانية)
    local lastMsg = log:GetChildren()[#log:GetChildren()]
    if lastMsg and lastMsg:IsA("Frame") and lastMsg:FindFirstChild("T").Text:find(txt) then return end

    local mFrame = Instance.new("Frame", log)
    mFrame.Size = UDim2.new(1, 0, 0, 30)
    mFrame.BackgroundTransparency = 1
    
    local img = Instance.new("ImageLabel", mFrame)
    img.Size = UDim2.new(0, 25, 0, 25)
    img.Image = game.Players:GetUserThumbnailAsync(senderUserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size48x48)
    Instance.new("UICorner", img).CornerRadius = UDim.new(1,0)
    
    local t = Instance.new("TextLabel", mFrame)
    t.Name = "T"
    t.Size = UDim2.new(1, -35, 1, 0)
    t.Position = UDim2.new(0, 35, 0, 0)
    t.BackgroundTransparency = 1
    t.Text = "<b>" .. senderName .. "</b>: " .. txt
    t.RichText = true
    t.TextColor3 = (senderName == Player.Name) and Color3.new(0,1,0.5) or Color3.new(1,1,1)
    t.TextXAlignment = Enum.TextXAlignment.Left
    t.TextSize = 14

    log.CanvasPosition = Vector2.new(0, 99999)
end

-- مراقبة كل اللاعبين
local function Listen(p)
    task.spawn(function()
        local backpack = p:WaitForChild("Backpack", 20)
        if backpack then
            local sig = GetSignal(p)
            sig.Changed:Connect(function(val)
                if val ~= "" then
                    AddMsg(p.Name, val, p.UserId)
                end
            end)
        end
    end)
end

for _, p in pairs(game.Players:GetPlayers()) do Listen(p) end
game.Players.PlayerAdded:Connect(Listen)

-- الإرسال
input.FocusLost:Connect(function(enter)
    if enter and input.Text ~= "" then
        if MySignal then
            MySignal.Value = input.Text
            task.wait(0.2)
            MySignal.Value = "" -- تصفير القيمة
        end
        input.Text = ""
    end
end)

btn.MouseButton1Click:Connect(function() frame.Visible = not frame.Visible end)
